name: MR Tagged Notification

permissions:
    pull-requests: read
    contents: read

on:
    pull_request:
        types: [labeled]
    workflow_dispatch:
        inputs:
            pr_number:
                description: 'PR number'
                required: true
                type: string
            tag_name:
                description: 'Tag name (e.g., release:testing)'
                required: true
                type: string

jobs:
    prepare:
        if: |
            (github.event_name == 'labeled' && startsWith(github.event.label.name, 'release:')) ||
            github.event_name == 'workflow_dispatch'
        runs-on: ubuntu-latest
        outputs:
            env_name: ${{ steps.config.outputs.env_name }}
            pr_body: ${{ steps.pr-body.outputs.pr_body }}
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Determine label and environment
              id: config
              run: |
                  if [ "${{ github.event_name }}" == "labeled" ]; then
                      LABEL_NAME="${{ github.event.label.name }}"
                  else
                      LABEL_NAME="${{ github.event.inputs.tag_name }}"
                  fi
                  
                  if [[ "$LABEL_NAME" =~ ^release:(.+)$ ]]; then
                      ENV_NAME="${BASH_REMATCH[1]}"
                      echo "Label: $LABEL_NAME"
                      echo "Environment: $ENV_NAME"
                      echo "env_name=$ENV_NAME" >> $GITHUB_OUTPUT
                  else
                      echo "Error: Label must start with 'release:'"
                      exit 1
                  fi

            - name: Setup GitHub CLI
              if: github.event_name == 'workflow_dispatch'
              uses: cli/cli-action@v1
              with:
                  version: latest

            - name: Get PR body
              id: pr-body
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  if [ "${{ github.event_name }}" == "labeled" ]; then
                      PR_BODY="${{ github.event.pull_request.body }}"
                  else
                      PR_NUMBER="${{ github.event.inputs.pr_number }}"
                      PR_BODY=$(gh pr view $PR_NUMBER --json body --jq '.body' || echo "")
                  fi
                  
                  echo "pr_body<<EOF" >> $GITHUB_OUTPUT
                  echo "$PR_BODY" >> $GITHUB_OUTPUT
                  echo "EOF" >> $GITHUB_OUTPUT

    notify:
        needs: prepare
        runs-on: ubuntu-latest
        environment: ${{ needs.prepare.outputs.env_name }}
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
            - name: Send MR info to API
              run: |
                  chmod +x .github/scripts/send-mr-notification.sh
                  .github/scripts/send-mr-notification.sh "${{ needs.prepare.outputs.pr_body }}"
