name: MR Tagged Notification

permissions:
    pull-requests: read
    contents: read

on:
    pull_request:
        types: [labeled]
    workflow_dispatch:
        inputs:
            pr_number:
                description: 'PR number'
                required: true
                type: string
            label_name:
                description: 'Label name'
                required: true
                type: choice
                options:
                    - release:testing
                    - release:staging
                    - release:development
                    - release:production

jobs:
    prepare:
        if: startsWith(github.event.label.name, 'release:') || github.event_name == 'workflow_dispatch'
        runs-on: ubuntu-latest
        outputs:
            env_name: ${{ steps.config.outputs.env_name }}
            pr_body: ${{ steps.pr-info.outputs.pr_body }}
            pr_number: ${{ steps.pr-info.outputs.pr_number }}
            pr_url: ${{ steps.pr-info.outputs.pr_url }}
        steps:
            - name: Determine label and environment
              id: config
              run: |
                  if [ "${{ github.event_name }}" == "pull_request" ]; then
                      LABEL_NAME="${{ github.event.label.name }}"
                  else
                      LABEL_NAME="${{ github.event.inputs.label_name }}"
                  fi
                  
                  if [[ "$LABEL_NAME" =~ ^release:(.+)$ ]]; then
                      ENV_NAME="${BASH_REMATCH[1]}"
                      echo "Label: $LABEL_NAME"
                      echo "Environment: $ENV_NAME"
                      echo "env_name=$ENV_NAME" >> $GITHUB_OUTPUT
                  else
                      echo "Error: Label must start with 'release:'"
                      exit 1
                  fi

            - name: Get PR info
              id: pr-info
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                  GH_REPO: ${{ github.repository }}
              run: |
                  if [ "${{ github.event_name }}" == "pull_request" ]; then
                      PR_BODY="${{ github.event.pull_request.body }}"
                      PR_NUMBER="${{ github.event.pull_request.number }}"
                      PR_URL="${{ github.event.pull_request.html_url }}"
                  else
                      PR_NUMBER="${{ github.event.inputs.pr_number }}"
                      echo "Fetching PR #$PR_NUMBER from $GH_REPO"
                      PR_BODY=$(gh pr view "$PR_NUMBER" --repo "$GH_REPO" --json body --jq '.body')
                      PR_URL=$(gh pr view "$PR_NUMBER" --repo "$GH_REPO" --json url --jq '.url')
                  fi
                  
                  echo "=== PR Info ==="
                  echo "PR Number: $PR_NUMBER"
                  echo "PR URL: $PR_URL"
                  echo "PR body length: ${#PR_BODY}"
                  echo "==============="
                  
                  echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
                  echo "pr_url=$PR_URL" >> $GITHUB_OUTPUT
                  echo "pr_body<<EOF" >> $GITHUB_OUTPUT
                  echo "$PR_BODY" >> $GITHUB_OUTPUT
                  echo "EOF" >> $GITHUB_OUTPUT

    notify:
        needs: prepare
        runs-on: ubuntu-latest
        environment: ${{ needs.prepare.outputs.env_name }}
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
            - name: Debug PR body
              run: |
                  echo "=== PR Body from prepare job ==="
                  echo "body is ${{ needs.prepare.outputs.pr_body }}"
                  echo "================================="
            - name: Send MR info to API
              env:
                  TTRAA_URL: ${{ vars.TTRAA_URL }}
                  SERVICE_KEY: ${{ secrets.SERVICE_KEY }}
                  PR_NUMBER: ${{ needs.prepare.outputs.pr_number }}
                  PR_URL: ${{ needs.prepare.outputs.pr_url }}
              run: |
                  chmod +x .github/scripts/send-mr-notification.sh
                  .github/scripts/send-mr-notification.sh "${{ needs.prepare.outputs.pr_body }}"
